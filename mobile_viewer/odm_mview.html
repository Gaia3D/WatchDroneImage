<!DOCTYPE html>
<html>
<head>
	<title>OpenDronMap Mobile Viewer</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link rel="shortcut icon" type="image/x-icon" href="images/gaia3d_logo_pavi.png" />

	<link rel="stylesheet" href="lib/leaflet.css" />
	<script src="lib/jquery-1.12.3.min.js"></script>
	<script src="lib/leaflet.js"></script>
	<script src="lib/leaflet-bing-layer.min.js"></script>
	<script src="lib/wms-capabilities.min.js"></script>

	<style>
    body { padding: 0; margin: 0; } html, body, #map { height: 100vh; width: 100vw; }
  </style>
</head>
<body>
<div id='map'></div>

<script>
  var WMS_URL = "/geoserver/wms";
  var WMS_CAPABILITIES_URL = WMS_URL + "?service=wms&version=1.1.1&request=GetCapabilities";
  var WMS_LAYER = "nurc:mosaic";
  var REFLASH_TIME = 10000;
  
  var map = null;
  var layerControl = null;
  
  $().ready(onInit);
  
  function onInit() {
    // 지도 콘트롤 초기화
    map = L.map('map', {
      center: [37.5, 127.0],
      zoom: 18,
    });
    
    // 배경지도 설정
    var BING_KEY = 'AuhiCJHlGzhg93IqUH_oCpl_-ZUrIE6SPftlyGYUvr9Amx5nzA-WqGcPquyFZl4L';
    var bingLayer = L.tileLayer.bing(BING_KEY).addTo(map);
    var mabBoxLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery © <a href="http://mapbox.com">Mapbox</a>',
      id: 'mapbox.streets'
    });
    
    // 배경지도 변경용 컨트롤
    var baseMaps = {"Bing Aerial" : bingLayer, "Streets": mabBoxLayer}
    layerControl = L.control.layers(baseMaps).addTo(map);
    
    // WMS GetCapabilities를 이용해 ODM의 범위 얻어와 이동
    $.ajax({
      url: WMS_CAPABILITIES_URL
    }).done(function(xml){
      try {
        capaJson = new WMSCapabilities(xml).toJSON();
        layers = capaJson.Capability.Layer.Layer;
        for (var i=0; i<layers.length; i++) {
          var layer = layers[i];
          if (layer.Name == WMS_LAYER) {
            var llBbox = layer.LatLonBoundingBox;
            console.log(llBbox);
            map.fitBounds([[llBbox[1], llBbox[0]],[llBbox[3], llBbox[2]]]);
            
            break;
          }
        }
      } catch (err) {
        console.error(err);
      }
    });

    // OpenDroneMap 레이어 계속 갱신되게 추가
    loadOdmLayer();
  }  
  
  var lowOdmLayer = null;
  var highOdmLayer = null;
  function loadOdmLayer() {
    if (!highOdmLayer) { // 초기화 안된 경우
      highOdmLayer = L.tileLayer.wms(WMS_URL, {
        layers: WMS_LAYER
        ,format: "image/png"
        ,transparent: true
        ,rand:Math.random()
      }).addTo(map);
      layerControl.addOverlay(highOdmLayer, "OpenDroneMap");
      
      // 지정 시간 경과후 계속 다시 로드
      setInterval(loadOdmLayer, REFLASH_TIME);
    }
    else { 
      // 뒤에서 다시 로드
      lowOdmLayer = L.tileLayer.wms(WMS_URL, {
        layers: WMS_LAYER
        ,format: "image/png"
        ,transparent: true
        ,rand:Math.random()
      });
      lowOdmLayer.bringToBack();
      
      // 켜져있는 상태인지 확인
      if (map.hasLayer(highOdmLayer)) {
        lowOdmLayer.addTo(map);
      }
      
      // 다 로드되었다는 이벤트 받으면 순서 뒤집기
      lowOdmLayer.on('load', flipOdmLayer);
    }
  }
  
  function flipOdmLayer() {
    if (!lowOdmLayer) return;
    
    // ODM Layer 상태 보존
    var isOn = map.hasLayer(highOdmLayer);
    if (isOn) {
      if (!map.hasLayer(lowOdmLayer))
        lowOdmLayer.addTo(map);
    } else {
      if (map.hasLayer(lowOdmLayer))
        lowOdmLayer.remove();
    }
    
    // 백그라운드에서 로딩된 이미지 앞으로 올리고
    lowOdmLayer.bringToFront();
    highOdmLayer.remove();

    // 레이어 콘트롤도 다시 갱신
    layerControl.removeLayer(highOdmLayer);
    highOdmLayer = lowOdmLayer;
    layerControl.addOverlay(highOdmLayer, "OpenDroneMap");
    
    lowOdmLayer = null;
  }
</script></body>
</html>